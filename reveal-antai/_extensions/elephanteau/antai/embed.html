<!-- Ant-AI Extension Resources -->
<style>
    /* Ant-AI Chat Widget CSS */

    #antai-chat-widget {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 9999;
        font-family: sans-serif;
        display: flex;
        flex-direction: column;
        align-items: flex-end;
    }

    #antai-chat-toggle {
        background-color: transparent;
        /* Transparent if image fills it */
        color: white;
        border: none;
        border-radius: 50%;
        width: 120px;
        height: 120px;
        padding: 0;
        font-size: 24px;
        cursor: pointer;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        display: flex;
        justify-content: center;
        align-items: center;
        transition: transform 0.2s;
    }

    #antai-chat-toggle:hover {
        transform: scale(1.1);
    }

    #antai-chat-container {
        display: none;
        width: 600px;
        height: 700px;
        background-color: white;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        margin-bottom: 20px;
        flex-direction: column;
        overflow: hidden;
        border: 1px solid #e0e0e0;
    }

    #antai-chat-container.expanded {
        width: 50vw;
        height: 85vh;
    }

    #antai-chat-header {
        background-color: #24008F;
        color: white;
        padding: 20px;
        font-weight: bold;
        font-size: 32px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .antai-header-buttons {
        display: flex;
        gap: 15px;
        align-items: center;
    }

    #antai-chat-header button {
        background: none;
        border: none;
        color: white;
        font-size: 36px;
        cursor: pointer;
        padding: 0 5px;
    }

    #antai-chat-messages {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        background-color: #f9f9f9;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .antai-message {
        max-width: 85%;
        padding: 16px 20px;
        border-radius: 18px;
        font-size: 28px;
        line-height: 1.6;
        /* Guard against global theme styles (e.g. `.user { position: ... }`) */
        flex: 0 0 auto;
    }

    .antai-message.antai-user {
        align-self: flex-end;
        background-color: #24008F;
        color: white;
        border-bottom-right-radius: 4px;
        position: relative;
        top: auto;
        right: auto;
        bottom: auto;
        left: auto;
        float: none;
        clear: both;
    }

    .antai-message.antai-ai {
        align-self: flex-start;
        background-color: #e9ecef;
        color: #333;
        border-bottom-left-radius: 4px;
        min-height: 40px;
        position: relative;
        top: auto;
        right: auto;
        bottom: auto;
        left: auto;
        float: none;
        clear: both;
    }

    /* Loading dots animation */
    .antai-loading-dots {
        display: inline-block;
        font-weight: bold;
        font-size: 32px;
    }

    .antai-loading-dots::after {
        content: '...';
        animation: antai-dots 1.5s steps(4, end) infinite;
        display: inline-block;
        width: 0;
        overflow: hidden;
        vertical-align: bottom;
    }

    @keyframes antai-dots {
        to {
            width: 1.25em;
        }
    }

    /* Markdown content styling */
    .antai-message p {
        margin: 0.5em 0;
    }

    .antai-message p:first-child {
        margin-top: 0;
    }

    .antai-message p:last-child {
        margin-bottom: 0;
    }

    .antai-message ul,
    .antai-message ol {
        margin: 0.5em 0;
        padding-left: 1.5em;
    }

    .antai-message li {
        margin: 0.25em 0;
    }

    .antai-message code {
        background-color: rgba(0, 0, 0, 0.05);
        padding: 0.2em 0.4em;
        border-radius: 3px;
        font-size: 0.9em;
        font-family: monospace;
    }

    .antai-message pre {
        background-color: rgba(0, 0, 0, 0.05);
        padding: 0.8em;
        border-radius: 5px;
        overflow-x: auto;
        margin: 0.5em 0;
    }

    .antai-message pre code {
        background: none;
        padding: 0;
    }

    .antai-message strong {
        font-weight: bold;
    }

    .antai-message em {
        font-style: italic;
    }

    .antai-message blockquote {
        border-left: 3px solid #24008F;
        padding-left: 1em;
        margin: 0.5em 0;
        color: #666;
    }

    #antai-chat-input-area {
        padding: 15px;
        border-top: 1px solid #e0e0e0;
        display: flex;
        gap: 10px;
        background-color: white;
    }

    #antai-chat-input {
        flex: 1;
        padding: 14px 18px;
        border: 1px solid #ccc;
        border-radius: 20px;
        outline: none;
        font-size: 24px;
    }

    #antai-chat-input:focus {
        border-color: #24008F;
    }

    #antai-chat-send {
        background-color: #24008F;
        color: white;
        border: none;
        border-radius: 50%;
        width: 48px;
        height: 48px;
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 20px;
    }
</style>

<!-- Marked.js for Markdown parsing -->
<script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>

<script>
    window.RevealAntAI = window.RevealAntAI || (() => {
        console.log("Ant-AI: Extension script loaded.");

        function getPluginConfig() {
            if (window.RevealAntAIConfig) {
                return window.RevealAntAIConfig;
            }
            if (typeof Reveal !== 'undefined' && Reveal.getConfig) {
                return Reveal.getConfig().antai || {};
            }
            return {};
        }

        function createWidget() {
            console.log("Ant-AI: Creating widget...");
            if (document.getElementById('antai-chat-widget')) {
                console.log("Ant-AI: Widget already exists.");
                return;
            }

            const config = getPluginConfig();
            const serverUrl = config.serverUrl || 'http://localhost:1234/v1/chat/completions';
            const apiKey = config.apiKey || 'dummy-key';

            const wrapper = document.createElement('div');
            wrapper.id = 'antai-chat-widget';

            const instructions = config.instructions || config.systemInstruction;
            let conversationHistory = [];
            if (instructions) {
                conversationHistory.push({ role: 'system', content: instructions });
            }

            const container = document.createElement('div');
            container.id = 'antai-chat-container';
            container.innerHTML = `
      <div id="antai-chat-header">
        <span>Ant-AI Chat</span>
        <div class="antai-header-buttons">
            <button id="antai-expand-btn" title="Toggle Size">⛶</button>
            <button id="antai-close-btn" title="Close">&times;</button>
        </div>
      </div>
      <div id="antai-chat-messages"></div>
      <div id="antai-chat-input-area">
        <input type="text" id="antai-chat-input" placeholder="Ask Ant-AI" />
        <button id="antai-chat-send">➤</button>
      </div>
    `;

            const toggleBtn = document.createElement('button');
            toggleBtn.id = 'antai-chat-toggle';
            toggleBtn.innerHTML = '<img src="_extensions/elephanteau/antai/antai_escp.png" alt="Ant-AI" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">';
            toggleBtn.title = "Open AI Chat";
            toggleBtn.onclick = () => {
                container.style.display = container.style.display === 'flex' ? 'none' : 'flex';
                if (container.style.display === 'flex') {
                    document.getElementById('antai-chat-input').focus();
                }
            };

            wrapper.appendChild(container);
            wrapper.appendChild(toggleBtn);
            document.body.appendChild(wrapper);

            // Event listeners
            document.getElementById('antai-close-btn').addEventListener('click', () => {
                container.style.display = 'none';
            });

            const expandBtn = document.getElementById('antai-expand-btn');
            expandBtn.addEventListener('click', () => {
                container.classList.toggle('expanded');
                expandBtn.textContent = container.classList.contains('expanded') ? '❐' : '⛶';
            });

            const input = document.getElementById('antai-chat-input');
            const sendBtn = document.getElementById('antai-chat-send');

            const addMessage = (text, sender, isMarkdown = false) => {
                const messagesDiv = document.getElementById('antai-chat-messages');
                if (!messagesDiv) return;
                const msgDiv = document.createElement('div');
                msgDiv.classList.add('antai-message', sender === 'user' ? 'antai-user' : 'antai-ai');
                if (text === '...') {
                    msgDiv.innerHTML = '<span class="antai-loading-dots"></span>';
                } else if (isMarkdown && typeof marked !== 'undefined') {
                    msgDiv.innerHTML = marked.parse(text);
                } else {
                    msgDiv.textContent = text;
                }
                messagesDiv.appendChild(msgDiv);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
                return msgDiv;
            };

            const typeMessage = async (text, element) => {
                const messagesDiv = document.getElementById('antai-chat-messages');
                let currentText = "";
                const typos = "qwertyuiopasdfghjklzxcvbnm";

                // Render complete markdown at the end for proper formatting
                for (let i = 0; i < text.length; i++) {
                    if (Math.random() < 0.02 && i < text.length - 1) {
                        const typo = typos[Math.floor(Math.random() * typos.length)];
                        element.textContent = currentText + typo + "|";
                        if (messagesDiv) messagesDiv.scrollTop = messagesDiv.scrollHeight;
                        await new Promise(r => setTimeout(r, 200));
                        element.textContent = currentText + "|";
                        if (messagesDiv) messagesDiv.scrollTop = messagesDiv.scrollHeight;
                        await new Promise(r => setTimeout(r, 150));
                    }
                    currentText += text[i];
                    element.textContent = currentText + "|";
                    if (messagesDiv) messagesDiv.scrollTop = messagesDiv.scrollHeight;
                    const delay = 20 + Math.random() * 50;
                    await new Promise(r => setTimeout(r, delay));
                }

                // Final render with markdown
                if (typeof marked !== 'undefined') {
                    element.innerHTML = marked.parse(currentText);
                } else {
                    element.textContent = currentText;
                }
                if (messagesDiv) messagesDiv.scrollTop = messagesDiv.scrollHeight;
            };

            const sendMessage = async () => {
                const text = input.value.trim();
                if (!text) return;

                conversationHistory.push({ role: 'user', content: text });
                addMessage(text, 'user');
                input.value = '';

                const loadingBubble = addMessage('...', 'ai');
                try {
                    const response = await fetch(serverUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({
                            model: config.model || 'gpt-3.5-turbo',
                            messages: conversationHistory
                        })
                    });
                    const data = await response.json();
                    const aiText = data.choices && data.choices[0] && data.choices[0].message ? data.choices[0].message.content : 'Error: Invalid response format';

                    conversationHistory.push({ role: 'assistant', content: aiText });

                    loadingBubble.remove();
                    const aiBubble = addMessage('', 'ai');
                    await typeMessage(aiText, aiBubble);
                } catch (error) {
                    console.error('Ant-AI Error:', error);
                    loadingBubble.remove();
                    addMessage('Error connecting to AI server.', 'ai');
                }
            };

            sendBtn.addEventListener('click', sendMessage);
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });
        }

        function init() {
            if (typeof Reveal === 'undefined') {
                setTimeout(init, 100);
                return;
            }
            if (Reveal.isReady()) {
                createWidget();
            } else {
                Reveal.addEventListener('ready', createWidget);
            }
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    })();
</script>